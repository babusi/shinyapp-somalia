#first install the following packages: readxl, mice, VIM, missForest, googlesheets. like: install.packages("googlesheets")
#apply CTRL + F --> SELECT ALL (put in find the name of the previous region to replace the other name of region in the sheet)**
library(readxl)
library(mice)
library(googlesheets)
library(dplyr)

#name your data framework (df) by reading data from excel <- this is just to run in a simple excel
#Bay <- read_excel("~/Desktop/14A.xlsx", 
#col_types = c("date", "numeric", "numeric"))

#TO RUN VIA GOOGLE SHEETS
#name your data framework (df) by reading data from googlesheets (automatizing)
myURL <-"https://docs.google.com/spreadsheets/d/e/2PACX-1vTGcnmYMki3euv4bcsgBqBRY1-sDl6zkVl0gGC8THLygJoYlYnfm4cY5bVCA8BXnmciFXnp6aEvow31/pub?gid=808293913&single=true&output=csv"
Bay<-read.csv(url(myURL))

#glimpse your google sheet to see also columns auto-assigned names
Bay %>% glimpse()

#register your google sheet
Baysheet <-gs_title("correlations")

#get the key of your sheet
Baysheet_key <-gs_gap_key()

#define variables/columns to be correlated - change depending on sheet **
Date <- Baysheet %>% gs_read(w= "Bay", range = "A1:A97")
actualarrivals <- (Baysheet %>% gs_read(w= "Bay", range = "B1:B97"))

#substitute name of the column depending on the function. (e.g. Column 1 = A, Column 2 = B, and Column C = 3, and so on...)
modelarrivals_BAYA1 <- Baysheet %>% gs_read(w= "Bay", range = "C1:C97")
modelarrivals_BAYA2 <- Baysheet %>% gs_read(w= "Bay", range = "D1:D97")
modelarrivals_BAYA3 <- Baysheet %>% gs_read(w= "Bay", range = "E1:E97")
modelarrivals_BAYA4 <- Baysheet %>% gs_read(w= "Bay", range = "F1:F97")
modelarrivals_BAYA5 <- Baysheet %>% gs_read(w= "Bay", range = "G1:G97")
modelarrivals_BAYA6 <- Baysheet %>% gs_read(w= "Bay", range = "H1:H97")
modelarrivals_BAYA7 <- Baysheet %>% gs_read(w= "Bay", range = "I1:I97")
modelarrivals_BAY1 <- Baysheet %>% gs_read(w= "Bay", range = "J1:J97")
modelarrivals_BAY2 <- Baysheet %>% gs_read(w= "Bay", range = "K1:K97")
modelarrivals_BAY3 <- Baysheet %>% gs_read(w= "Bay", range = "L1:L97")
modelarrivals_BAY4 <- Baysheet %>% gs_read(w= "Bay", range = "M1:M97")
modelarrivals_BAY5 <- Baysheet %>% gs_read(w= "Bay", range = "N1:N97")
modelarrivals_BAY6 <- Baysheet %>% gs_read(w= "Bay", range = "O1:O97")
modelarrivals_BAY7 <- Baysheet %>% gs_read(w= "Bay", range = "P1:P97")
modelarrivals_BAY8 <- Baysheet %>% gs_read(w= "Bay", range = "Q1:Q97")
modelarrivals_BAY9 <- Baysheet %>% gs_read(w= "Bay", range = "R1:R97")
modelarrivals_BAY10 <- Baysheet %>% gs_read(w= "Bay", range = "S1:S97")
modelarrivals_BAY11 <- Baysheet %>% gs_read(w= "Bay", range = "T1:T97")
modelarrivals_BAY12 <- Baysheet %>% gs_read(w= "Bay", range = "U1:U97")
modelarrivals_BAY13 <- Baysheet %>% gs_read(w= "Bay", range = "V1:V97")
modelarrivals_BAY14 <- Baysheet %>% gs_read(w= "Bay", range = "W1:W97")
modelarrivals_BAY15 <- Baysheet %>% gs_read(w= "Bay", range = "X1:X97")
modelarrivals_BAY16 <- Baysheet %>% gs_read(w= "Bay", range = "Y1:Y97")
modelarrivals_BAY17 <- Baysheet %>% gs_read(w= "Bay", range = "Z1:Z97")
modelarrivals_minus1_1 <- Baysheet %>% gs_read(w= "Bay", range = "AA1:AA97")
modelarrivals_minus1_2 <- Baysheet %>% gs_read(w= "Bay", range = "AB1:AB97")
modelarrivals_minus1_3 <- Baysheet %>% gs_read(w= "Bay", range = "AC1:AC97")
modelarrivals_minus1_4 <- Baysheet %>% gs_read(w= "Bay", range = "AD1:AD97")
modelarrivals_minus1_5 <- Baysheet %>% gs_read(w= "Bay", range = "AE1:AE97")

#plot variables, with title just to visualize them
plot(x,y, main="Actual Arrivals vs. Model Arrivals, Bay", xlab="Actual Arrivals", ylab="Model Arrivals", pch=15, cex=1, col="blue")

#install mice for imputation of NAs prior COR
#install.packages("mice")
library(mice)

#understanding missing patterns of data
md.pattern(Bay)

#visualize missing patterns, install package
#install.packages("VIM")
library(VIM)
#install.packages("missForest")
library(missForest)

#graph missing data by %. If more than 50% then is not ideal to run a correlation
aggr_plot <- aggr(Bay, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(Bay), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))

#another visual
marginplot(Bay[c(1,2)])


#----> RE-RUN from here the MICE correlation everytime need to change variable<-----

#Generate 10% missing values at Random 
arrivals.mis <- prodNA(Bay, noNA = 0.1)
summary(arrivals.mis)

#In case needed: remove categorical variables
#arrivals.mis <- subset(arrivals.mis, select = -c(Date))
#summary(arrivals.mis)

#select only the variables you need to correlate (subset)  
#lapply(arrivals.mis, as.numeric) 
arrivals.mis <-select(arrivals.mis, actualarrivals, modelarrivals_BAY10) #<-- CHANGE HERE TOO THE MODELARRIVALS.X variable to run different ones

#imputation of NAs
arrivalsimp<- mice(arrivals.mis, m=5, maxit=50, meth='pmm', seed=500)
summary(arrivalsimp)

completeData <- complete(arrivalsimp,2)

#correlation for machine/human to decide the best fit
cor(completeData)
